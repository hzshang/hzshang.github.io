<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>操作系统-IDE控制器&nbsp;|&nbsp;Roadmap of Learning</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="操作系统-IDE控制器">
  
  
    <meta property="og:image" content="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8c0347c-750a-4c09-9937-743af45dcdc8%2F51J3C8VS52L._AC_.jpg?table=block&amp;id=99298f0e-ba64-4792-9396-52a631c39e3f">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="project.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📽️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>Project</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🙋🏻‍♂️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8c0347c-750a-4c09-9937-743af45dcdc8%2F51J3C8VS52L._AC_.jpg?table=block&amp;id=99298f0e-ba64-4792-9396-52a631c39e3f"></span>
      </div>
    
    <h1 class="Header__Title">操作系统-IDE控制器</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Thu, Nov 4, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/Operating System.html">Operating System</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/99298f0eba644792939652a631c39e3f" class="PageRoot"><div id="https://www.notion.so/556f02a08842410fb9d5f3248df5a450" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最新在研究虚拟机逃逸，对于大部分虚拟机程序来说，一个很大攻击面就是PCI设备实现。不同的PCI设备，它们的交互方法、通信协议千差万别，需要逐个分析。又是到了考验操作系统基本功的时候了，大学时没好好上操作系统，落下的课果然是要还的。在这里开个坑，介绍各种设备的交互方法，以及一些简单的代码实现。</span></span></p></div><div id="https://www.notion.so/5721e9d6f4154dfeb606178e65e3e884" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/275a249da2e84b2ea7a296ca2e337aa3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">IDE控制器(Integrated Drive Electronics)是一个用来读写硬盘的设备，准确来讲应该是一个连接器，是操作系统和磁盘驱动器通信的桥梁。</span></span></p></div><div id="https://www.notion.so/75c43cb0b03b4502a3a1f033633f30f3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e1fbeb9dd95d48b296895a301164f55e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个IDE外设有两个Channel，分别为Primary和Secondary，每个Channel又分别可以连接Master和Slave两个drive。所以一个IDE外设可以最多连接四块硬盘，标准的名称分别是</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/dc45eded61bf4f779cabf137ae0d1962" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Primary Master Drive.</span></span></li><li id="https://www.notion.so/163fcd3bac714047951adf515cb155cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Primary Slave Drive.</span></span></li><li id="https://www.notion.so/7753dd339df147d8ba4867e8b122cb3a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Secondary Master Drive.</span></span></li><li id="https://www.notion.so/c608ab491bbf45cb9914d9b1947f027e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Secondary Slave Drive.</span></span></li></ul><h2 id="https://www.notion.so/6d5dd3ccf9a343e38c0bb6f06e983a52" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6d5dd3ccf9a343e38c0bb6f06e983a52"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">PCI设备探测</span></span></h2><div id="https://www.notion.so/e49a96b83069459197f47c07da2ccf53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果一个PCI设备的</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">class code</strong></span><span class="SemanticString">为0x01（Mass Storage Controller），</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">subclass code</strong></span><span class="SemanticString"> 为 0x01 (IDE)，就说明是IDE控制器。我们通过IDE进行磁盘读写操作需要使用到5个基址，分别存放在PCI的BAR0，BAR1，BAR2，BAR3，BAR4。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/014fd1d5a32f4723a26257d6ae9eed8c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">BAR0 Primary Master Drive的数据起始地址，默认为0x1F0</span></span></li><li id="https://www.notion.so/63f740a2fd8846d5af42e60824d967f5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">BAR1 Primary Master Drive的控制地址，默认为0x3F6</span></span></li><li id="https://www.notion.so/c7e37719720f4835ac339695ddf28957" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">BAR2 Secondary Master Drive的数据起始地址，默认为0x170</span></span></li><li id="https://www.notion.so/bd14acdfbf5243e38670701f5ad9f19a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">BAR3 Secondary Master Drive的控制地址，默认为0x376</span></span></li><li id="https://www.notion.so/910a9aa3bf26408d9fa7e3161fafda5d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">BAR4 Bus master IDE起始地址，控制驱动器使用DMA方式进行数据交互</span></span></li></ul><div id="https://www.notion.so/46bbb3adc5594f568bf482552636bce4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">IDE控制器的每个channel有16个寄存器，通过上面的BAR进行寻址。比如Primary Channel的寄存器信息如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/eb46fa2ea7064cc0a2d8f5e453e14dad" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Data Register: BAR0 + 0; // Read-Write</span></span></li><li id="https://www.notion.so/fde2b3c7175d4f19855afec2e9e05a33" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Error Register: BAR0 + 1; // Read Only</span></span></li><li id="https://www.notion.so/fb08c52b37d942bdbf36bbf6ecf57182" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Features Register: BAR0 + 1; // Write Only</span></span></li><li id="https://www.notion.so/4a6a13d1987a4b60949cdc2d22d003b5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SECCOUNT0: BAR0 + 2; // Read-Write</span></span></li><li id="https://www.notion.so/2cff949510844c34936f530b1d712980" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA0: BAR0 + 3; // 将Control Register的最高位置0再进行读写</span></span></li><li id="https://www.notion.so/bd04fc3e08b5477c9cb9246bb3ad8332" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA1: BAR0 + 4; // 将Control Register的最高位置0再进行读写</span></span></li><li id="https://www.notion.so/ce94f972b31a4285be7c8aac8b707733" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA2: BAR0 + 5; // 将Control Register的最高位置0再进行读写</span></span></li><li id="https://www.notion.so/6d2f86b9d9654756925e13af605679aa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA3: BAR0 + 3; // 将Control Register的最高位置1再进行读写</span></span></li><li id="https://www.notion.so/34ed69e5922348d6b7c17d0dd87811f0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA4: BAR0 + 4; // 将Control Register的最高位置1再进行读写</span></span></li><li id="https://www.notion.so/6b5c1dcabf8143a9b71dc0708982d1f6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA5: BAR0 + 5; // 将Control Register的最高位置1再进行读写</span></span></li><li id="https://www.notion.so/7503dca8bc7a46b79ad2d0384e7923d7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">HDDEVSEL: BAR0 + 6; // Read-Write, used to select a drive in the channel.</span></span></li><li id="https://www.notion.so/45b86146f6784c2694d84a68ad520de5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Command Register: BAR0 + 7; // Write Only.</span></span></li><li id="https://www.notion.so/3bf2c9b6048d4de98fd969dec3df9fa9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Status Register: BAR1 + 7; // Read Only.</span></span></li><li id="https://www.notion.so/5240f852cd4d4957a21fb08a1aa2881b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Alternate Status Register: BAR1 + 2; // Read Only.</span></span></li><li id="https://www.notion.so/567f76205516448f8f08e77f56821a20" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Control Register: BAR1 + 2; // Write Only.</span></span></li><li id="https://www.notion.so/bc088481708f4109806d6201016cc731" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">DEVADDRESS: BAR1 + 3;</span></span></li></ul><div id="https://www.notion.so/98dfb15231064199aae7cd222c17ba66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">读写寄存器代码封装</span></span></p></div><pre id="https://www.notion.so/27752bc109284229b18e4d0439fb1dbf" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_DATA</span>       <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_ERROR</span>      <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_FEATURES</span>   <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_SECCOUNT0</span>  <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA0</span>       <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA1</span>       <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA2</span>       <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_HDDEVSEL</span>   <span class="token expression"><span class="token number">0x06</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_COMMAND</span>    <span class="token expression"><span class="token number">0x07</span> </span><span class="token comment">// for read</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_STATUS</span>     <span class="token expression"><span class="token number">0x07</span> </span><span class="token comment">// for write</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_SECCOUNT1</span>  <span class="token expression"><span class="token number">0x08</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA3</span>       <span class="token expression"><span class="token number">0x09</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA4</span>       <span class="token expression"><span class="token number">0x0A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_LBA5</span>       <span class="token expression"><span class="token number">0x0B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_CONTROL</span>    <span class="token expression"><span class="token number">0x0C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_ALTSTATUS</span>  <span class="token expression"><span class="token number">0x0C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_REG_DEVADDRESS</span> <span class="token expression"><span class="token number">0x0D</span></span></span>

<span class="token keyword">void</span> <span class="token function">ide_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> channel<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">></span> <span class="token number">0x07</span> <span class="token operator">&amp;&amp;</span> reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		<span class="token comment">//Set this to read back the High Order Byte of the last LBA48 value sent to an IO port.</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token operator">|</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x08</span><span class="token punctuation">)</span>
		<span class="token function">outb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base  <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x00</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		<span class="token function">outb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base  <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x06</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x0E</span><span class="token punctuation">)</span>
		<span class="token function">outb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl  <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x16</span><span class="token punctuation">)</span>
		<span class="token function">outb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">></span> <span class="token number">0x07</span> <span class="token operator">&amp;&amp;</span> reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> channel<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> result<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">></span> <span class="token number">0x07</span> <span class="token operator">&amp;&amp;</span> reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token operator">|</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x08</span><span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token function">inb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token function">inb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base  <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x0E</span><span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token function">inb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl  <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">&lt;</span> <span class="token number">0x16</span><span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token function">inb</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">+</span> reg <span class="token operator">-</span> <span class="token number">0x0E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">></span> <span class="token number">0x07</span> <span class="token operator">&amp;&amp;</span> reg <span class="token operator">&lt;</span> <span class="token number">0x0C</span><span class="token punctuation">)</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/a2e7bd0fba1e4bd6942116dacafdb347" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5a7eed2cde71423fbe6bd2bbdea39a17" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们要读写磁盘一般有ATA和ATAPI两种接口，不同的接口规格在交互上有些许差别。</span></span></p></div><div id="https://www.notion.so/8f80fa4e688740f892a28b1f593b6ba3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面是如何区分ATA、ATAPI驱动器的初始化代码</span></span></p></div><pre id="https://www.notion.so/9c0f08274b6f4bbb8bc9bf1f8352596d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ide_initialize</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> bar0<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bar1<span class="token punctuation">,</span>
                           <span class="token class-name">uint16_t</span> bar2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bar3<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bar4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">// 1- Detect I/O Ports which interface IDE Controller:</span>
	channels<span class="token punctuation">[</span>ATA_PRIMARY  <span class="token punctuation">]</span><span class="token punctuation">.</span>base  <span class="token operator">=</span> <span class="token punctuation">(</span>bar0 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x1F0</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">!</span>bar0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>ATA_PRIMARY  <span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl  <span class="token operator">=</span> <span class="token punctuation">(</span>bar1 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x3F6</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">!</span>bar1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>ATA_SECONDARY<span class="token punctuation">]</span><span class="token punctuation">.</span>base  <span class="token operator">=</span> <span class="token punctuation">(</span>bar2 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x170</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">!</span>bar2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>ATA_SECONDARY<span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl  <span class="token operator">=</span> <span class="token punctuation">(</span>bar3 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x376</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">!</span>bar3<span class="token punctuation">)</span><span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>ATA_PRIMARY  <span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">=</span> <span class="token punctuation">(</span>bar4 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Bus Master IDE</span>
	channels<span class="token punctuation">[</span>ATA_SECONDARY<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">=</span> <span class="token punctuation">(</span>bar4 <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFC</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Bus Master IDE</span>
	<span class="token comment">// 2- Disable IRQs:</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>ATA_PRIMARY  <span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>ATA_SECONDARY<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 3- Detect ATA-ATAPI Devices:</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">uint8_t</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token class-name">uint8_t</span> type <span class="token operator">=</span> IDE_ATA<span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>reserved <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment">// (I) Select Drive:</span>
			<span class="token function">ide_write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> <span class="token number">0xA0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Select Drive.</span>
			<span class="token function">ide_delay</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// (II) Send ATA Identify Command:</span>
			<span class="token function">ide_write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_IDENTIFY<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ide_delay</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This function should be implemented in your OS. which waits for 1 ms.</span>
			<span class="token comment">// it is based on System Timer Device Driver.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ide_read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_STATUS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">uint8_t</span> status <span class="token operator">=</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">&amp;</span> ATA_SR_ERR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>err <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment">// If Err, Device is not ATA.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>status <span class="token operator">&amp;</span> ATA_SR_BSY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>status <span class="token operator">&amp;</span> ATA_SR_DRQ<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// Everything is right.</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">unsigned</span> <span class="token keyword">char</span> cl <span class="token operator">=</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token number">0x14</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token number">0xEB</span><span class="token punctuation">)</span>
					type <span class="token operator">=</span> IDE_ATAPI<span class="token punctuation">;</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token number">0x69</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token number">0x96</span><span class="token punctuation">)</span>
					type <span class="token operator">=</span> IDE_ATAPI<span class="token punctuation">;</span>
				<span class="token keyword">else</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// Unknown Type (may not be a device).</span>
				<span class="token function">ide_write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_IDENTIFY_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">babysleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>ide_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ide_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// (V) Read Identification Space of the Device:</span>
			<span class="token function">ide_read_buffer</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ATA_REG_DATA<span class="token punctuation">,</span> ide_buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// (VI) Read Device Parameters:</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>reserved     <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span> type<span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>channel      <span class="token operator">=</span> i<span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>drive        <span class="token operator">=</span> j<span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>signature    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ide_buf <span class="token operator">+</span> ATA_IDENT_DEVICETYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>capabilities <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ide_buf <span class="token operator">+</span> ATA_IDENT_CAPABILITIES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>commandSets  <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ide_buf <span class="token operator">+</span> ATA_IDENT_COMMANDSETS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// (VII) Get Size:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>commandSets <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Device uses 48-Bit Addressing:</span>
				ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ide_buf <span class="token operator">+</span> ATA_IDENT_MAX_LBA_EXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// Device uses CHS or 28-bit Addressing:</span>
				ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ide_buf <span class="token operator">+</span> ATA_IDENT_MAX_LBA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>

			<span class="token comment">// (VIII) String indicates model of device (like Western Digital HDD and SONY DVD-RW...):</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> k <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>model<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> ide_buf<span class="token punctuation">[</span>ATA_IDENT_MODEL <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>model<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ide_buf<span class="token punctuation">[</span>ATA_IDENT_MODEL <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Terminate String.</span>

			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>udma <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>mdma <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token comment">//check udma support</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> bit <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> bit <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> bit<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_buf<span class="token punctuation">[</span>ATA_IDENT_UDMASUP<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>udma <span class="token operator">=</span> bit<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> bit <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> bit <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> bit<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_buf<span class="token punctuation">[</span>ATA_IDENT_MDMASUP<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					ide_devices<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>mdma <span class="token operator">=</span> bit<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 4- Print Summary:</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>reserved <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"IDE[%d:%d] %s Drive %dMB - %s\n"</span><span class="token punctuation">,</span>
			      ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">,</span> ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token string">"ATA"</span><span class="token punctuation">,</span> <span class="token string">"ATAPI"</span><span class="token punctuation">}</span><span class="token punctuation">[</span>ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">/* Type */</span>
			ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>               <span class="token comment">/* Size */</span>
			ide_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/7626d80baca84d52b8bbc7024f886ce6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/7626d80baca84d52b8bbc7024f886ce6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">IDE磁盘读写</span></span></h2><div id="https://www.notion.so/a50ba88a79574878843a7cb97f1cb16f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在实现磁盘读写操作之前，有必要弄清楚IDE控制器的几种交互方法。</span></span></p></div><h3 id="https://www.notion.so/1270072f023e42348d9bdeeeac94505d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1270072f023e42348d9bdeeeac94505d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">PIO模式</span></span></h3><div id="https://www.notion.so/a8cc201b2cd54907976c745c98f24844" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">磁盘的数据使用io port进行传输，所有的IDE外设均支持此模式。</span></span></p></div><h3 id="https://www.notion.so/8818c4b012f344edad17972d443334bb" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8818c4b012f344edad17972d443334bb"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">DMA模式</span></span></h3><div id="https://www.notion.so/fd1fcc71ca7d4db6be8ecd38b14fee9a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DMA即Direct Memory Access，IDE外设通过memory bus直接访问内存进行数据传输，速度比PIO快。当PCI设备的Prog If寄存器的第七个bit为0时，表示该控制器不支持DMA模式。</span></span></p></div><div id="https://www.notion.so/9f0624a3b45d438d84f1f6a2ccc2e2b5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/0a7f2753855f4eb58aac4d227073cc89" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上文提到了ATA、ATAPI两种驱动器，因此我们需要我们一共需要实现以下几个函数</span></span></p></div><div id="https://www.notion.so/f7c298c871204a318ec1f93d2df2d8c6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ata_pio_read、ata_pio_write、ata_dma_read、ata_dma_write、</span></span></p></div><div id="https://www.notion.so/edaa6ba1a4b8482c9f66bf1d824e7b7a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">atapi_pio_read、atapi_pio_write、atapi_dma_read、atapi_dma_write</span></span></p></div><div id="https://www.notion.so/b1b0305c06b74ce1adc1aeb0692cf698" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5bde0ebdd45345519be3718b714108cc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们知道，老式磁盘由扇区构成，现代磁盘可以直接通过地址访问。在实现上，一共有三种定位磁盘读写位置的方法：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/8982fe722a5e46649a7569784756e66e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">CHS 通过扇区定位读写位置，所有驱动器均支持此方式</span></span></li><li id="https://www.notion.so/6c75c18d19884decb6fd3d9b845c3871" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA24 通过28bit的地址访问磁盘位置，最多访问128G磁盘</span></span></li><li id="https://www.notion.so/9eb08bc4b14b4628b1b436ff0470d7e3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">LBA48 通过48bit的地址访问磁盘</span></span></li></ul><div id="https://www.notion.so/ce1503d696e64bc7a4fdde968217cc46" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在实际选择时，可以通过当前读写的位置选择合适的方法，代码如下</span></span></p></div><pre id="https://www.notion.so/8088886fbdfd4172994e29034fb4eb44" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token class-name">uint8_t</span> <span class="token function">ide_access_drive</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> channel<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> drive<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> lba<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> numsects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> lba_mode<span class="token punctuation">;</span> <span class="token comment">/* 0: CHS, 1:LBA28, 2: LBA48 */</span>
	<span class="token class-name">uint8_t</span> head<span class="token punctuation">,</span> sect<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> cyl<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> lba_io<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>lba <span class="token operator">></span> <span class="token number">0x10000000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Sure Drive should support LBA in this case, or you are giving a wrong LBA.</span>
		lba_mode  <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x000000FF</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x0000FF00</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x00FF0000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0xFF000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// We said that we lba is integer, so 32-bit are enough to access 2TB.</span>
		lba_io<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// We said that we lba is integer, so 32-bit are enough to access 2TB.</span>
		head      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Lower 4-bits of HDDEVSEL are not used here.</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> <span class="token number">0x200</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
		lba_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x00000FF</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x000FF00</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0x0FF0000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// These Registers are not used here.</span>
		lba_io<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// These Registers are not used here.</span>
		lba_io<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// These Registers are not used here.</span>
		head      <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">&amp;</span> <span class="token number">0xF000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		lba_mode  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		sect      <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">%</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		cyl <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">+</span> <span class="token number">1</span>  <span class="token operator">-</span> sect<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> sect<span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cyl <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cyl <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		lba_io<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		head      <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">+</span> <span class="token number">1</span>  <span class="token operator">-</span> sect<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Head number is written to HDDEVSEL lower 4-bits.</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_STATUS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ATA_SR_BSY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait if Busy.</span>

	<span class="token comment">// (IV) Select Drive from the controller;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>lba_mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> <span class="token number">0xA0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Select Drive CHS.</span>
	<span class="token keyword">else</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> <span class="token number">0xE0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Select Drive LBA.</span>
	<span class="token comment">// (V) Write Parameters;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>lba_mode <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_SECCOUNT1<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA3<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA4<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA5<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_SECCOUNT0<span class="token punctuation">,</span>   numsects<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA0<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">,</span>   lba_io<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> lba_mode<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/c1a06c93ead844b8a4b42ab09c754cd8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f9ada8db375a4802aff5657d17a52380" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">接下来我们先实现基于PIO读写磁盘的函数</span></span></p></div><pre id="https://www.notion.so/51b7aa7d51c0407e96533f60f7139c97" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_READ_PIO</span>          <span class="token expression"><span class="token number">0x20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_READ_PIO_EXT</span>      <span class="token expression"><span class="token number">0x24</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_READ_DMA</span>          <span class="token expression"><span class="token number">0xC8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_READ_DMA_EXT</span>      <span class="token expression"><span class="token number">0x25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_WRITE_PIO</span>         <span class="token expression"><span class="token number">0x30</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_WRITE_PIO_EXT</span>     <span class="token expression"><span class="token number">0x34</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_WRITE_DMA</span>         <span class="token expression"><span class="token number">0xCA</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_WRITE_DMA_EXT</span>     <span class="token expression"><span class="token number">0x35</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_CACHE_FLUSH</span>       <span class="token expression"><span class="token number">0xE7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_CACHE_FLUSH_EXT</span>   <span class="token expression"><span class="token number">0xEA</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_PACKET</span>            <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_IDENTIFY_PACKET</span>   <span class="token expression"><span class="token number">0xA1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA_CMD_IDENTIFY</span>          <span class="token expression"><span class="token number">0xEC</span></span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_ata_pio_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> 
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> words <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> bus <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> lba_mode <span class="token operator">=</span> <span class="token function">ide_access_drive</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>drive<span class="token punctuation">,</span>lba<span class="token punctuation">,</span>numsects<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_delay</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> lba_mode <span class="token operator">==</span><span class="token number">2</span> <span class="token operator">?</span> ATA_CMD_READ_PIO_EXT<span class="token operator">:</span>ATA_CMD_READ_PIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 	<span class="token class-name">uint8_t</span> err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> err<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">insw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span>addr<span class="token punctuation">,</span>words<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr <span class="token operator">+=</span> words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_ata_pio_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> 
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> words <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> bus <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> lba_mode <span class="token operator">=</span> <span class="token function">ide_access_drive</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>drive<span class="token punctuation">,</span>lba<span class="token punctuation">,</span>numsects<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_delay</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> lba_mode <span class="token operator">==</span><span class="token number">2</span> <span class="token operator">?</span> ATA_CMD_WRITE_PIO_EXT<span class="token operator">:</span>ATA_CMD_WRITE_PIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 	<span class="token class-name">uint8_t</span> err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> err<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span>addr<span class="token punctuation">,</span>words<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr <span class="token operator">+=</span> words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span>lba_mode <span class="token operator">==</span> <span class="token number">2</span><span class="token operator">?</span>ATA_CMD_CACHE_FLUSH_EXT<span class="token operator">:</span>ATA_CMD_CACHE_FLUSH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_atapi_pio_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span>
                                 <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>   words      <span class="token operator">=</span> <span class="token number">2048</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Sector Size in Words, Almost All ATAPI Drives has a sector size of 2048 bytes.</span>
	<span class="token class-name">uint8_t</span> err<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>   bus      <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> ide_irq_invoked <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_FEATURES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PIO mode</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">,</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Lower Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">,</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Upper Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Send the Command.</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ATAPI_CMD_READ<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> numsects<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>
	<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> atapi_packet<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// Wait for an IRQ.</span>
		err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>      <span class="token comment">// Polling and return if error.</span>
		<span class="token function">insw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> words<span class="token punctuation">)</span><span class="token punctuation">;</span>
		addr <span class="token operator">+=</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_atapi_pio_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span>
                                  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>   words      <span class="token operator">=</span> <span class="token number">2048</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Sector Size in Words, Almost All ATAPI Drives has a sector size of 2048 bytes.</span>
	<span class="token class-name">uint8_t</span> err<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>   bus      <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> ide_irq_invoked <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_FEATURES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PIO mode</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">,</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Lower Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">,</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Upper Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Send the Command.</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ATAPI_CMD_READ<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> numsects<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>
	<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> atapi_packet<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// Wait for an IRQ.</span>
		err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>      <span class="token comment">// Polling and return if error.</span>
		<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> words<span class="token punctuation">)</span><span class="token punctuation">;</span>
		addr <span class="token operator">+=</span> <span class="token punctuation">(</span>words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/4c54c64fbcd04841a5878ca00f041c82" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于DMA模式，需要使用到Bus master port，即PCI驱动里的BAR4。该基址空间为16字节，每个channel使用8个字节。具体每个字节的意义可以在一本名为《Programming Interface for Bus Master IDE Controller》的小册子里找到，大概意思就是需要我们向这里写入一个内存地址，告诉IDE控制器，在我们发送命令以后不需要再等待io传输数据，直接从约定的物理地址里读写数据即可。</span></span></p></div><div id="https://www.notion.so/1ec5c69b6cef4eedbd3c758644b9c332" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">具体实现代码如下</span></span></p></div><pre id="https://www.notion.so/28b0e4b54a8148c5a23e0f981efc1695" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_ata_dma_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> 
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>  drive      <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> words <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> port <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide<span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	region_desc<span class="token operator">*</span> prd_table <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>prd_table<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">,</span><span class="token string">'\xcc'</span><span class="token punctuation">,</span>numsects<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// prepare dma</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>numsects<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>words<span class="token punctuation">]</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span> words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	prd_table<span class="token punctuation">[</span>numsects<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span>
	<span class="token function">outl</span><span class="token punctuation">(</span>port <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>prd_table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_STATUS<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//clear err intr</span>
	<span class="token comment">// access driver</span>
	<span class="token class-name">uint16_t</span> lba_mode <span class="token operator">=</span> <span class="token function">ide_access_drive</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>drive<span class="token punctuation">,</span>lba<span class="token punctuation">,</span>numsects<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_delay</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> lba_mode <span class="token operator">==</span><span class="token number">2</span> <span class="token operator">?</span> ATA_CMD_READ_DMA_EXT<span class="token operator">:</span>ATA_CMD_READ_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">,</span><span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">,</span>numsects<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_ata_dma_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> 
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>  drive      <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> words <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
	<span class="token comment">// uint16_t port = channels[channel].bmide;</span>
	region_desc<span class="token operator">*</span> prd_table <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>prd_table<span class="token punctuation">;</span>
	channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ide_irq_invoked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">,</span>addr<span class="token punctuation">,</span>numsects<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// prepare dma</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>numsects<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>words<span class="token punctuation">]</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span> words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	prd_table<span class="token punctuation">[</span>numsects<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//write</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_STATUS<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//clear err intr</span>
	<span class="token comment">// access driver</span>
	<span class="token class-name">uint16_t</span> lba_mode <span class="token operator">=</span> <span class="token function">ide_access_drive</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>drive<span class="token punctuation">,</span>lba<span class="token punctuation">,</span>numsects<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_delay</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> lba_mode <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> ATA_CMD_WRITE_DMA_EXT<span class="token operator">:</span>ATA_CMD_WRITE_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">,</span><span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_atapi_dma_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span>
                                 <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> words <span class="token operator">=</span> <span class="token number">2048</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Sector Size in Words, Almost All ATAPI Drives has a sector size of 2048 bytes.</span>
	<span class="token class-name">uint8_t</span> err<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> bus <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> ide_irq_invoked <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_FEATURES<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PIO mode</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Lower Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Upper Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Send the Command.</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ATAPI_CMD_READ<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> numsects<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>
	region_desc<span class="token operator">*</span> prd_table <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>prd_table<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">[</span>i<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span> words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	prd_table<span class="token punctuation">[</span>numsects <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span>
	<span class="token function">outl</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">+</span> IDE_DMA_PRD<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>prd_table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> atapi_packet<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">,</span>numsects<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">ide_atapi_dma_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> idx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span>
                                  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> channel <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> drive <span class="token operator">=</span> ide_devices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>drive<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> words <span class="token operator">=</span> <span class="token number">2048</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Sector Size in Words, Almost All ATAPI Drives has a sector size of 2048 bytes.</span>
	<span class="token class-name">uint8_t</span> err<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> bus <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_CONTROL<span class="token punctuation">,</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>nIEN <span class="token operator">=</span> ide_irq_invoked <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_HDDEVSEL<span class="token punctuation">,</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_FEATURES<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PIO mode</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Lower Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_LBA2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Upper Byte of Sector Size.</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_COMMAND<span class="token punctuation">,</span> ATA_CMD_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Send the Command.</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ATAPI_CMD_WRITE<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lba <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> numsects<span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	atapi_packet<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">ide_polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>
	region_desc<span class="token operator">*</span> prd_table <span class="token operator">=</span> channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>prd_table<span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">,</span>addr<span class="token punctuation">,</span>numsects<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>dma_buffer<span class="token punctuation">[</span>i<span class="token operator">*</span>words<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span> words <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
		prd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	prd_table<span class="token punctuation">[</span>numsects <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span>
	<span class="token function">outl</span><span class="token punctuation">(</span>channels<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span>bmide <span class="token operator">+</span> IDE_DMA_PRD<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>prd_table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_STATUS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">outsw</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> atapi_packet<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_wait_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ide_write</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">,</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> ATA_REG_DMA_CMD<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/c551994dbe1944be9a254ffb5869207a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">至此我么已经完成了所有的读写方法，最后将上面的几个函数封装一下</span></span></p></div><pre id="https://www.notion.so/2c2ee1103c3345b095523c36005af9b9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">ide_read_sectors</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> drive<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1: Check if the drive presents:</span>
	<span class="token comment">// ==================================</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>drive <span class="token operator">></span> <span class="token number">3</span> <span class="token operator">||</span> ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>reserved <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>      <span class="token comment">// Drive Not Found!</span>

	<span class="token comment">// 2: Check if inputs are valid:</span>
	<span class="token comment">// ==================================</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lba <span class="token operator">+</span> numsects<span class="token punctuation">)</span> <span class="token operator">></span> ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
		package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span>                     <span class="token comment">// Seeking to invalid position.</span>

	<span class="token comment">// 3: Read in PIO Mode through Polling &amp; IRQs:</span>
	<span class="token comment">// ============================================</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> err<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>dma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"read from ata using dma\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">ide_ata_dma_read</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"read from ata using pio\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">ide_ata_pio_read</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numsects<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>dma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"read from atapi using dma\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					err <span class="token operator">=</span> <span class="token function">ide_atapi_dma_read</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> addr <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"read from atapi using pio\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					err <span class="token operator">=</span> <span class="token function">ide_atapi_pio_read</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> addr <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ide_print_error</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ide_write_sectors</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> drive<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> numsects<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lba<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1: Check if the drive presents:</span>
	<span class="token comment">// ==================================</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>drive <span class="token operator">></span> <span class="token number">3</span> <span class="token operator">||</span> ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>reserved <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>      <span class="token comment">// Drive Not Found!</span>
	<span class="token comment">// 2: Check if inputs are valid:</span>
	<span class="token comment">// ==================================</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lba <span class="token operator">+</span> numsects<span class="token punctuation">)</span> <span class="token operator">></span> ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
		package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span>                     <span class="token comment">// Seeking to invalid position.</span>
	<span class="token comment">// 3: Read in PIO Mode through Polling &amp; IRQs:</span>
	<span class="token comment">// ============================================</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> err<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>dma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"write from ata using dma\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">ide_ata_dma_write</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"write from ata using pio\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">ide_ata_pio_write</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> IDE_ATAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ide_devices<span class="token punctuation">[</span>drive<span class="token punctuation">]</span><span class="token punctuation">.</span>dma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				err <span class="token operator">=</span> <span class="token function">ide_atapi_dma_write</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				err <span class="token operator">=</span> <span class="token function">ide_atapi_pio_write</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> lba<span class="token punctuation">,</span> numsects<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		package<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ide_print_error</span><span class="token punctuation">(</span>drive<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/f6566804159c442abb4b8fa001d0cb0b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ecc0d4a78f124f23913b817301ae739f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/cfeb10dad38144c2ba0f7b636ddb9305" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/0c9aba92d60445c0a4285e591588a179" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0c9aba92d60445c0a4285e591588a179"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">参考链接</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/1519414ee8ac4e5495badbefcd2c9401" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://wiki.osdev.org/PCI_IDE_Controller">https://wiki.osdev.org/PCI_IDE_Controller</a></span></span></li><li id="https://www.notion.so/c8553c79220d4a028a213848c6ba5bef" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.opennet.ru/docs/FAQ/hardware/ide-part2.html">https://www.opennet.ru/docs/FAQ/hardware/ide-part2.html</a></span></span></li><li id="https://www.notion.so/de5bf0d394a14410b99f2562f742bc4a" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/alberinfo/Slidoor-OS/tree/8a9280b624f397a339de27943b93e1c41d6244bc/kernel/src/drivers/ata">https://github.com/alberinfo/Slidoor-OS/tree/8a9280b624f397a339de27943b93e1c41d6244bc/kernel/src/drivers/ata</a></span></span></li></ol></article>
<script src="https://utteranc.es/client.js"
        repo="hzshang/hzshang.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  <footer class="Footer">
  <div>&copy; Roadmap of Learning 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>
